# 스마트 도어락 시스템
기간 : 2017.03.26~2017.06.21   
참여인원: 4명   



## Ⅰ. 개요

 ### 1) 개발 목적 
 맞벌이 가족이 증가함에 따라 집이 비거나 아이가 혼자서 집을 지키게 되는 경우가 많아졌고, 그 것을 노리고 주거침입을 시도하여 범행을 저지르려는 사람들 또한 늘어나고 있다. 하지만 현재 우리가 흔히 사용하는 기존 도어락의 기능으로는 낯선 사람이 비밀번호를 알게 되면 쉽게 출입이 가능하고, 범행 시간동안 집 주인은 그 것을 알 수 없어서 범행이 이미 일어난 뒤 그것을 해결해야하는 어려움 등이 발생한다. 이는 가정집뿐 만이 아니라 중요한 정보가 많은 사무실이나 연구실 등에서도 마찬가지일 것이다.
지금은 4차 산업혁명을 이끌어갈 사물인터넷(IoT)시대이다. 생소하기만 했던 이 단어가 어느새 우리 생활 속에 깊이 스며들어있다. 우리는 이 점점 발전하는 사물인터넷 기술을 접목하여 이러한 문제점을 보완하여 몇 가지 기능을 추가한 도어락을 만들어보고자 하였다.

 ### 2) 개발 목표 
- 수업시간에 학습한 아두이노와 여려 모듈의 사용법을 활용하여 도어락을 구현해 본다.
- 카메라 모듈, SD카드 모듈을 이해하고 사용법을 익혀 도어락에 적용한다.
- Blynk라는 어플리케이션을 이용하여 원격으로 아두이노를 컨트롤할 수 있는 방안을 도색해본다.
- 프로젝트를 진행하며 발생하는 여러 가지 문제점과 그에 대한 해결방안을 통한 주체적인 학습을 진행한다.

<br>   

## Ⅱ. 개발 과정
### 1) 전체 설계
- 키패드, 블루투스를 이용한 입력 제어
- passcheck 알고리즘, flag연산을 통한 출력의 방향 결정
- 비밀번호 판별 결과에 따른 LED, 부저, 서보모터, Serial출력
- TWI 통신을 통해 두 아두이노 우노 보드를 연결
- 카메라 모듈과 SD카드 리더기 모듈을 사용한 사진 촬영 및 저장
- Blynk 어플리케이션을 이용한 도어락 원격 제어 및 확인 시스템
 
### 2) 개발 일정

 |날짜|활동|내용|역할 분담|   
 |-----|-----|-----|-----|
 |3/26|아이디어 회의|스마트 도어락 시스템(인증 절차를 거쳐 등록된 스마트 폰으로 잠금 해제)|김윤기, 박다혜, 김민근, 김지수|
|3/26~4/24|각자 자료조사|안드로이드, 와이파이, 도어락|김윤기, 박다혜, 김민근, 김지수|
4/24|아이디어 회의|아이디어 수정(+사진, 휴대폰으로 상태 전송), 역할 분배|김윤기, 박다혜, 김민근, 김지수|
|5/4|물품 구매|키패드 모듈|박다혜|
|5/9~5/10|블루투스 기능 있는 도어락 구현|서보모터, 거리감지센서, |박다혜
|-|-|부저, LED, 스위치|김지수
|-|-|키패드|김민근
|-|-|블루투스|김윤기
|5/15|집 모형 제작|집 모형 만들고, 모듈 연결|김윤기, 박다혜, 김민근, 김지수
|5/15|도어락 전체 구현|코드 일부 수정(부저)|김지수, 박다혜
|-|-|순서대로 도어락 구현|김윤기, 박다혜, 김민근, 김지수
|5/17|도어락 전체 구현|코드 일부 수정 및 전체 구현|김윤기, 박다혜, 김민근, 김지수
|5/30|자료 조사|클라우드 서비스(Ubidots)|박다혜
|-|-|Blynk |김윤기, 김민근
|-|-|카메라 모듈|김지수
|6/7|자료조사, 물품구매|사진 서버 전송 방법 조사|박다혜, 김지수
|-|-|Blynk 사용|김윤기, 김민근
|-|-|카메라 모듈, SD카드 어댑터 구매|김지수, 박다혜
|6/18~6/19|각자 파트 코드 작성|사진 촬영 및 사진 저장|김지수, 박다혜
|-|-|아두이노 TWI 통신|김지수
|-|-|Blynk|김윤기, 김민근
|6/20~6/21|보고서작성, 코드 수정, 전체 동작 확인|코드 수정 및 전체 동작 확인|김윤기, 박다혜, 김민근, 김지수
|-|-|보고서 작성|김지수
|6/21|보고서, 영상|보고서 작성, 동영상 촬영|김윤기, 박다혜, 김민근, 김지수
|-|-|동영상 편집|김지수|

### 3) 부품 설명
|부품 사진|이름|개수|
|-----|-----|-----|
|![아두이노 우노 보드](/img/arduino_uno.png)|아두이노 우노 보드|2|
|![아두이노 메가 보드](/img/arduino_mega.png)|아두이노 메가 + 와이파이 쉴드(wizfi 310) |1|
|![서보 모터](/img/survo_motor.png)|서보 모터|1|
|![거리 감지 센서](/img/distance_sensor.png)|거리 감지 센서|1|
|![키패드 모듈](/img/keypad_module.png)|키패드 모듈|1|
|![블루투스 모듈](/img/bluetooth_module_HC06.png)|블루투스 모듈|1|
|![부저](/img/buzzer.png)|부저|1|
|![LED](/img/led.png)|LED|2|
|![스위치](/img/switch.png)|스위치|1|
|![저항](/img/resistance_10k.png)![저항](/img/resistance_330.png)|저항|-|
|![TTL시리얼 JPEG 카메라 모듈](/img/camera_module.png)|TTL시리얼 JPEG 카메라 모듈|1|
|![MicroSD 카드 리더기](/img/microSD_reader.png)|MicroSD 카드 리더기|1|
 
 <br>   
 
## Ⅲ. 세부 작품 내용
### 1) 구상도   
 ![구상도](/img/diagram.png)
### 2) 소스코드
[Keypad module - Arduino Uno 1](https://github.com/dev-dahye/WIZNETIAN-IoT-Contest/blob/main/src/uno1.ino)   
[Camera module - Arduino Uno 2](https://github.com/dev-dahye/WIZNETIAN-IoT-Contest/blob/main/src/uno2.ino)   
[Blynk - Arduino Mega](https://github.com/dev-dahye/WIZNETIAN-IoT-Contest/blob/main/src/mega.ino)   
### 3) 회로도
<Keypad module - Arduino Uno 1>   
 ![회로도](/img/schematic1.png)   
<Camera module - Arduino Uno 2>   
 ![회로도](/img/schematic2.png)   
<TWI 통신으로 Uno1 과 Uno2를 연결>   
 ![회로도](/img/schematic3.png)   
<LED 신호로 Uno와 Mega 연결>   
 ![회로도](/img/schematic4.png)   
<전체 회로도>    
 ![회로도](/img/schematic5.png)   
### 4) 작동 과정 및 결과
키패드로 비밀번호를 입력받는다. passcheck 함수를 호출하여 원래 비밀번호와 비교를 한다. 비밀번호가 일치한다면 flag=1이 되고 다음의 동작들을 하게 된다. 서보모터 동작(잠금장치 해제), correctMelody 부저 동작, 초록색 LED 점등, "door open"이라는 Serial.print, 거리감지센서 동작 시작한다. 만약 비밀번호가 일치하지 않는다면 flag=-1이 되고 다음의 동작들을 하게 된다. closeMelody 부저 동작, 빨간색 LED 점등, “wrong password!"라는 Serial.print, flag=0으로 초기화한다. 그래서 다음 입력을 받을 준비를 한다.
잠금장치가 열리면 거리감지센서가 동작을 시작해 문이 닫힐 때까지 거리를 측정한다. distance<9 임이 두 번 확인되면(문이 완전히 닫힘을 확인하기 위해) 서보모터가 동작하여 잠금장치를 걸고 closeMelody 부저가 동작하고 flag=0으로 초기화를 한다. 
도어락의 안쪽에는 스위치 모듈이 있는데 이것이 눌리면 flag=1로 바뀌면서 다음의 동작을 한다. 서보모터 동작(잠금장치 해제), correctMelody 부저 동작, 초록색 LED 점등, "door open"이라는 Serial.print, 거리감지센서 동작 시작한다.
LED 신호로 UNO와 Mega를 연결한다. 아두이노 메가는 와이파이 쉴드가 부착된 wizfi310을 사용한다. 신호를 받으면 blynk.notify함수를 통해 미리 등록해 둔 스마트폰으로 푸시알림이 울린다. 

 ### 5) 문제 해결 과정
- 거리감지센서를 문 지방에 딱 붙도록 부착하였더니 제대로 거리를 감지하지 못해 문이 닫혔다는 것을 인식하지 못했다. 거리감지센서가 감지하는 거리를 시리얼모니터로 측정해보면서 일정 거리이상 가까워지면 실제 거리보다 훨씬 길게 측정된다는 것을 알게 되었고 문과 어느 정도 거리를 둔 곳에 거리감지센서를 부착하는 것으로 문제를 해결하였다.
- TWI 통신에서의 리시브이벤트 함수 안에 사진을 찍기 위한 코드를 넣었더니 사진이 찍혔다는 출력문 나왔지만 저장되는 사진의 바이트가 0 이었다. flag 변수를 이용해서 리시브이벤트함수가 일어났을때만 loop문에서 사진이 찍히도록 하여 문제를 해결했다.
- 카메라모듈을 처음 받았을 때 도선이 전혀 연결되어있지 않은 상태였기 때문에 직접 납땜을 해서 도선을 연결하였다. 
- 가장 문제였던 것은 카메라모듈의 연결문제였다. 분명히 작동하던 카메라가 갑자기 작동하지 않아서 카메라 모듈에 전류가 흐르는지 LED로 확인했고 납땜을 3번이나 다시 해봤다. 길게 연결된 점프선을 전부 바꿔보는 것도 2번이나 했다. 점프선을 바꿨을 때 제대로 동작하는 것을 확인했고 처음에는 전선들을 정리하다가 너무 많이 움직여서 안쪽에서 끊어진 것이 아닌가, 카메라 모듈이 점프선에 과부하를 주는 것이 아닌가하고 의심해봤지만 결론은 새로 업로드할때마다 카메라의 선들을 다시 연결해주어야 하는 것임을 알게되었다.  
– Blynk를 이용해서 틀린 비밀번호가 입력되었을 때 핸드폰으로 알림을 받게 하기 위해서 keypad모듈과 연결되어있던 우노보드를 wizfi310과 연결된 메가 보드로 변경하였으나 keypad 라이브러리와 blynk 라이브러리가 알 수 없는 충돌을 일으켰다. 라이브러리 자체를 변경할수 없었으므로 우노보드 두 개와 메가보드 하나를 모두 TWI통신으로 연결하려 하였지만 blynk 코드안의 리시브이벤트함수가 제대로 작동하지 않았기 때문에 실패하였고 고민 끝에 비밀번호가 틀리면 동작하는 빨간 LED가 켜지는 신호를 메가에서는 입력신호로 받아와서 알림을 보내는 방법으로 문제를 해결하였다

<br>

## 참고자료 
- http://blog.naver.com/woals719/220934628518 - 아두이노 도어락 오픈
- https://kocoafab.cc/fboard/590 - 아두이노 서버, 데이터 전송(사진)
- http://cafe.naver.com/arduinostory/38525 - 아두이노 사진 서버 전송
- http://blog.naver.com/roboholic84/220483456256 - 아두이노와 카메라 모듈로 사진 촬영
- http://blog.naver.com/yuyyulee/220548025758 - 와이파이 통신 – webserver
- http://wiznetian.com/article/wizarduino-ubidots-%ed%81%b4%eb%9d%bc%ec%9a%b0%eb%93%9c-%ec%97%b0%eb%8f%99/ - 클라우드 서비스(Ubidots)
- http://blog.daum.net/rockjjy99 - 아두이노 통신
- http://wiznetian.com/article/wizfi310-%ec%95%84%eb%91%90%ec%9d%b4%eb%85%b8-%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac%ec%97%90%ec%84%9c-%ec%a7%80%ec%9b%90%ed%95%98%ec%a7%80-%ec%95%8a%eb%8a%94-wizfi310-%ea%b8%b0%eb%8a%a5/ - 아두이노 쉴드 정보
- http://cafe.naver.com/arduinostory/32049 - 아두이노 통신
- http://blog.naver.com/PostView.nhn?blogId=opusk&logNo=220986288719&redirect=Dlog&widgetTypeCall=true - blynk 라이브러리 포팅
- https://www.youtube.com/watch?v=12CUhNlBXGc - 아두이노 카메라 프로토 타입
- http://blog.naver.com/PostView.nhn?blogId=roboholic84&logNo=220821919602 - 아두이노로 ip카메라 만들기
- http://blog.naver.com/roboholic84/220483456256 - 카메라 모듈 이용
이 외 여러 블로그, 카페에서 회로도 참고.
